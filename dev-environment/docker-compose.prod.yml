# 운영 환경 - 빌드된 이미지 사용
# 인프라는 docker-compose.infra.yml 먼저 실행 필요
# 사용: docker compose -f docker-compose.infra.yml -f docker-compose.prod.yml up -d

services:
  # Auth Service (빌드된 이미지)
  auth-service:
    image: all-erp/auth-service:${VERSION:-latest}
    container_name: all-erp-auth-service-prod
    environment:
      NODE_ENV: production
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-1h}
    ports:
      - "${AUTH_SERVICE_PORT:-3001}:3001"
    networks:
      - all-erp-network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # System Service (빌드된 이미지)
  system-service:
    image: all-erp/system-service:${VERSION:-latest}
    container_name: all-erp-system-service-prod
    environment:
      NODE_ENV: production
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
    ports:
      - "${SYSTEM_SERVICE_PORT:-3002}:3002"
    networks:
      - all-erp-network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Tenant Service (빌드된 이미지)
  tenant-service:
    image: all-erp/tenant-service:${VERSION:-latest}
    container_name: all-erp-tenant-service-prod
    environment:
      NODE_ENV: production
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
    ports:
      - "${TENANT_SERVICE_PORT:-3006}:3006"
    networks:
      - all-erp-network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  all-erp-network:
    name: all-erp-network
    external: true  # infra.yml에서 생성한 네트워크 사용
