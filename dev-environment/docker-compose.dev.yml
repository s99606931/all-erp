# 개발 환경 - 애플리케이션 서비스만 포함
# 인프라는 docker-compose.infra.yml 먼저 실행 필요
#
# 사용 예시:
# 1. 전체 서비스 실행:
#    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d
#
# 2. 특정 도메인만 실행 (프로필 사용):
#    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile system up -d
#    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile hr up -d
#    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile finance up -d
#    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile general up -d
#    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile ai up -d
#
# 3. 여러 도메인 동시 실행:
#    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml --profile system --profile hr up -d

services:
  # Auth Service (인증/인가)
  auth-service:
    profiles: ['system']
    build:
      context: ..
      dockerfile: apps/system/auth-service/Dockerfile.dev
    container_name: all-erp-auth-service-dev
    env_file:
      - ../apps/system/auth-service/.env
    ports:
      - '${AUTH_SERVICE_PORT:-3001}:3001'
      - '9229:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules # node_modules는 컨테이너 내부 것 사용
    command: sh -c "pnpm prisma generate --schema=apps/system/auth-service/prisma/schema.prisma && exec pnpm nx serve auth-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # System Service (시스템/공통)
  system-service:
    profiles: ['system']
    build:
      context: ..
      dockerfile: apps/system/system-service/Dockerfile.dev
    container_name: all-erp-system-service-dev
    env_file:
      - ../apps/system/system-service/.env
    ports:
      - '${SYSTEM_SERVICE_PORT:-3002}:3002'
      - '9230:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/system/system-service/prisma/schema.prisma && exec pnpm nx serve system-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Tenant Service (테넌트/구독 관리)
  tenant-service:
    profiles: ['system']
    build:
      context: ..
      dockerfile: apps/system/tenant-service/Dockerfile.dev
    container_name: all-erp-tenant-service-dev
    env_file:
      - ../apps/system/tenant-service/.env
    ports:
      - '${TENANT_SERVICE_PORT:-3006}:3006'
      - '9231:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/system/tenant-service/prisma/schema.prisma && exec pnpm nx serve tenant-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Personnel Service (인사 정보 관리)
  personnel-service:
    profiles: ['hr']
    build:
      context: ..
      dockerfile: apps/hr/personnel-service/Dockerfile.dev
    container_name: all-erp-personnel-service-dev
    env_file:
      - ../apps/hr/personnel-service/.env
    ports:
      - '${PERSONNEL_SERVICE_PORT:-3011}:3011'
      - '9232:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/hr/personnel-service/prisma/schema.prisma && exec pnpm nx serve personnel-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Payroll Service (급여 계산 및 관리)
  payroll-service:
    profiles: ['hr']
    build:
      context: ..
      dockerfile: apps/hr/payroll-service/Dockerfile.dev
    container_name: all-erp-payroll-service-dev
    env_file:
      - ../apps/hr/payroll-service/.env
    ports:
      - '${PAYROLL_SERVICE_PORT:-3012}:3012'
      - '9233:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/hr/payroll-service/prisma/schema.prisma && exec pnpm nx serve payroll-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Attendance Service (근태 관리)
  attendance-service:
    profiles: ['hr']
    build:
      context: ..
      dockerfile: apps/hr/attendance-service/Dockerfile.dev
    container_name: all-erp-attendance-service-dev
    env_file:
      - ../apps/hr/attendance-service/.env
    ports:
      - '${ATTENDANCE_SERVICE_PORT:-3013}:3013'
      - '9234:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/hr/attendance-service/prisma/schema.prisma && exec pnpm nx serve attendance-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Budget Service (예산 관리)
  budget-service:
    profiles: ['finance']
    build:
      context: ..
      dockerfile: apps/finance/budget-service/Dockerfile.dev
    container_name: all-erp-budget-service-dev
    env_file:
      - ../apps/finance/budget-service/.env
    ports:
      - '${BUDGET_SERVICE_PORT:-3021}:3021'
      - '9235:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/finance/budget-service/prisma/schema.prisma && exec pnpm nx serve budget-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Accounting Service (회계 관리)
  accounting-service:
    profiles: ['finance']
    build:
      context: ..
      dockerfile: apps/finance/accounting-service/Dockerfile.dev
    container_name: all-erp-accounting-service-dev
    env_file:
      - ../apps/finance/accounting-service/.env
    ports:
      - '${ACCOUNTING_SERVICE_PORT:-3022}:3022'
      - '9236:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/finance/accounting-service/prisma/schema.prisma && exec pnpm nx serve accounting-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Settlement Service (결산 관리)
  settlement-service:
    profiles: ['finance']
    build:
      context: ..
      dockerfile: apps/finance/settlement-service/Dockerfile.dev
    container_name: all-erp-settlement-service-dev
    env_file:
      - ../apps/finance/settlement-service/.env
    ports:
      - '${SETTLEMENT_SERVICE_PORT:-3023}:3023'
      - '9237:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/finance/settlement-service/prisma/schema.prisma && exec pnpm nx serve settlement-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Asset Service (자산 관리)
  asset-service:
    profiles: ['general']
    build:
      context: ..
      dockerfile: apps/general/asset-service/Dockerfile.dev
    container_name: all-erp-asset-service-dev
    env_file:
      - ../apps/general/asset-service/.env
    ports:
      - '${ASSET_SERVICE_PORT:-3031}:3031'
      - '9238:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/general/asset-service/prisma/schema.prisma && exec pnpm nx serve asset-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Supply Service (비품 관리)
  supply-service:
    profiles: ['general']
    build:
      context: ..
      dockerfile: apps/general/supply-service/Dockerfile.dev
    container_name: all-erp-supply-service-dev
    env_file:
      - ../apps/general/supply-service/.env
    ports:
      - '${SUPPLY_SERVICE_PORT:-3032}:3032'
      - '9239:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/general/supply-service/prisma/schema.prisma && exec pnpm nx serve supply-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # General Affairs Service (총무 관리)
  general-affairs-service:
    profiles: ['general']
    build:
      context: ..
      dockerfile: apps/general/general-affairs-service/Dockerfile.dev
    container_name: all-erp-general-affairs-service-dev
    env_file:
      - ../apps/general/general-affairs-service/.env
    ports:
      - '${GENERAL_AFFAIRS_SERVICE_PORT:-3033}:3033'
      - '9240:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/general/general-affairs-service/prisma/schema.prisma && exec pnpm nx serve general-affairs-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # AI Service (AI 기능 및 LLM 연동)
  ai-service:
    profiles: ['ai']
    build:
      context: ..
      dockerfile: apps/ai/ai-service/Dockerfile.dev
    container_name: all-erp-ai-service-dev
    env_file:
      - ../apps/ai/ai-service/.env
    ports:
      - '${AI_SERVICE_PORT:-3007}:3007'
      - '9241:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=libs/shared/infra/prisma/schema.prisma && exec pnpm nx serve ai-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Approval Service (결재 관리)
  approval-service:
    profiles: ['platform']
    build:
      context: ..
      dockerfile: apps/platform/approval-service/Dockerfile.dev
    container_name: all-erp-approval-service-dev
    env_file:
      - ../apps/platform/approval-service/.env
    ports:
      - '${APPROVAL_SERVICE_PORT:-3041}:3041'
      - '9243:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/platform/approval-service/prisma/schema.prisma && exec pnpm nx serve approval-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped


  # Report Service (보고서 관리)
  report-service:
    profiles: ["platform"]
    build:
      context: ..
      dockerfile: apps/platform/report-service/Dockerfile.dev
    container_name: all-erp-report-service-dev
    env_file:
      - ../apps/platform/report-service/.env
    ports:
      - "${REPORT_SERVICE_PORT:-3042}:3042"
      - "9244:9229"  # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/platform/report-service/prisma/schema.prisma && exec pnpm nx serve report-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # File Service (파일 관리)
  file-service:
    profiles: ["platform"]
    build:
      context: ..
      dockerfile: apps/platform/file-service/Dockerfile.dev
    container_name: all-erp-file-service-dev
    env_file:
      - ../apps/platform/file-service/.env
    ports:
      - "${FILE_SERVICE_PORT:-3044}:3044"
      - "9246:9229"  # 디버깅 포트 (9245에서 9246으로 변경)
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/platform/file-service/prisma/schema.prisma && exec pnpm nx serve file-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

  # Notification Service (알림 관리)
  notification-service:
    profiles: ['platform']
    build:
      context: ..
      dockerfile: apps/platform/notification-service/Dockerfile.dev
    container_name: all-erp-notification-service-dev
    env_file:
      - ../apps/platform/notification-service/.env
    ports:
      - '${NOTIFICATION_SERVICE_PORT:-3043}:3043'
      - '9245:9229' # 디버깅 포트
    volumes:
      - ../apps:/workspace/apps:cached
      - ../libs:/workspace/libs:cached
      - /workspace/node_modules
    command: sh -c "pnpm prisma generate --schema=apps/platform/notification-service/prisma/schema.prisma && exec pnpm nx serve notification-service --host=0.0.0.0"
    networks:
      - all-erp-network
    restart: unless-stopped

networks:
  all-erp-network:
    name: all-erp-network
    external: true # infra.yml에서 생성한 네트워크 사용

