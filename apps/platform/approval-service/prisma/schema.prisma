datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
    binaryTargets = ["native", "debian-openssl-3.0.x"]
  output   = "../node_modules/.prisma/approval-client"
  engineType    = "library"
}

// 결재 요청
model ApprovalRequest {
  id              Int      @id @default(autoincrement())
  requestType     String   @map("request_type")  // 예: PAYROLL, BUDGET, PURCHASE
  referenceId     Int      @map("reference_id")  // 원본 문서 ID
  referenceType   String   @map("reference_type")  // 원본 문서 타입
  requesterId     Int      @map("requester_id")  // 요청자 ID (auth-service)
  status          String   // PENDING, APPROVED, REJECTED, CANCELED
  title           String
  description     String?
  priority        String   @default("NORMAL")  // URGENT, HIGH, NORMAL, LOW
  tenantId        Int      @map("tenant_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  approvalLines   ApprovalLine[]
  histories       ApprovalHistory[]

  @@index([tenantId])
  @@index([requesterId])
  @@index([status])
  @@map("approval_requests")
}

// 결재선
model ApprovalLine {
  id                Int      @id @default(autoincrement())
  approvalRequestId Int      @map("approval_request_id")
  approverId        Int      @map("approver_id")  // 결재자 ID (auth-service)
  sequence          Int      // 결재 순서
  status            String   @default("PENDING")  // PENDING, APPROVED, REJECTED
  comment           String?
  approvedAt        DateTime? @map("approved_at")
  tenantId          Int      @map("tenant_id")
  createdAt         DateTime @default(now()) @map("created_at")

  approvalRequest   ApprovalRequest @relation(fields: [approvalRequestId], references: [id])

  @@unique([approvalRequestId, sequence])
  @@index([approverId])
  @@map("approval_lines")
}

// 결재 이력
model ApprovalHistory {
  id                Int      @id @default(autoincrement())
  approvalRequestId Int      @map("approval_request_id")
  action            String   // SUBMITTED, APPROVED, REJECTED, CANCELED
  actorId           Int      @map("actor_id")  // 행위자 ID
  comment           String?
  tenantId          Int      @map("tenant_id")
  createdAt         DateTime @default(now()) @map("created_at")

  approvalRequest   ApprovalRequest @relation(fields: [approvalRequestId], references: [id])

  @@index([approvalRequestId])
  @@map("approval_histories")
}

// 멱등성
model ProcessedEvent {
  eventId     String   @id @map("event_id")
  processedAt DateTime @map("processed_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("processed_events")
}

model OutboxEvent {
  id        String   @id @default(uuid())
  eventId   String   @unique @map("event_id")
  eventType String   @map("event_type")
  payload   String
  status    String   @default("PENDING")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("outbox_events")
}
