# PRD 6.3 완료 보고서: 최종 테스트 및 운영 배포

## 작업 요약

**PRD**: [`6.3_final_deployment.md`](file:///data/all-erp/docs/tasks/phase6-ops/6.3_final_deployment.md)  
**목표**: 통합 테스트 완료 및 운영 환경 안정적 배포  
**상태**: ⚠️ **배포 가이드 작성 완료** (실제 배포는 운영팀 작업 필요)

---

## 구현 가이드

### 1. E2E (End-to-End) 테스트 구현

#### 1.1 Playwright 설치 및 설정

```bash
# Playwright 설치
cd /data/all-erp
pnpm add -D @playwright/test

# 브라우저 설치
pnpm exec playwright install

# Playwright 설정 파일 생성
pnpm exec playwright init
```

#### playwright.config.ts
```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  
  use: {
    baseURL: 'http://localhost:4200',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],

  webServer: {
    command: 'pnpm nx serve web-admin',
    url: 'http://localhost:4200',
    reuseExistingServer: !process.env.CI,
  },
})
```

#### 1.2 주요 E2E 시나리오

##### 인증 흐름 테스트 (`e2e/auth.spec.ts`)
```typescript
import { test, expect } from '@playwright/test'

test.describe('Authentication Flow', () => {
  test('should login successfully with valid credentials', async ({ page }) => {
    await page.goto('/login')
    
    await page.fill('input[name="email"]', 'admin@example.com')
    await page.fill('input[name="password"]', 'admin123')
    await page.click('button[type="submit"]')
    
    // Should redirect to dashboard
    await expect(page).toHaveURL('/dashboard')
    
    // Should show user name
    await expect(page.locator('text=관리자')).toBeVisible()
  })

  test('should show error with invalid credentials', async ({ page }) => {
    await page.goto('/login')
    
    await page.fill('input[name="email"]', 'wrong@example.com')
    await page.fill('input[name="password"]', 'wrongpass')
    await page.click('button[type="submit"]')
    
    // Should show error message
    await expect(page.locator('text=로그인 실패')).toBeVisible()
  })

  test('should redirect to login when accessing protected page without auth', async ({ page }) => {
    await page.goto('/dashboard')
    
    // Should redirect to login
    await expect(page).toHaveURL('/login')
  })
})
```

##### 직원 관리 흐름 테스트 (`e2e/hr-workflow.spec.ts`)
```typescript
import { test, expect } from '@playwright/test'

test.describe('HR Workflow', () => {
  test.beforeEach(async ({ page }) => {
    // Login first
    await page.goto('/login')
    await page.fill('input[name="email"]', 'hr@example.com')
    await page.fill('input[name="password"]', 'hr123')
    await page.click('button[type="submit"]')
    await expect(page).toHaveURL('/dashboard')
  })

  test('should complete employee registration flow', async ({ page }) => {
    // Navigate to employees page
    await page.click('text=인사관리')
    await expect(page).toHaveURL('/hr/employees')
    
    // Click add button
    await page.click('button:has-text("직원 등록")')
    
    // Fill employee form
    await page.fill('input[name="name"]', '홍길동')
    await page.fill('input[name="email"]', 'hong@example.com')
    await page.selectOption('select[name="departmentId"]', 'dept-1')
    await page.fill('input[name="position"]', '대리')
    await page.fill('input[name="salary"]', '3000000')
    await page.fill('input[name="joinDate"]', '2024-01-01')
    
    // Submit form
    await page.click('button[type="submit"]')
    
    // Should show success message
    await expect(page.locator('text=직원이 등록되었습니다')).toBeVisible()
    
    // Should see new employee in list
    await expect(page.locator('text=홍길동')).toBeVisible()
  })

  test('should calculate payroll correctly', async ({ page }) => {
    await page.goto('/hr/payroll')
    
    // Select employee
    await page.selectOption('select[name="employeeId"]', 'emp-1')
    
    // Select month
    await page.fill('input[name="month"]', '2024-01')
    
    // Click calculate
    await page.click('button:has-text("급여 계산")')
    
    // Should show calculated payroll
    await expect(page.locator('text=기본급')).toBeVisible()
    await expect(page.locator('text=세금')).toBeVisible()
    await expect(page.locator('text=실수령액')).toBeVisible()
  })
})
```

##### 예산 집행 흐름 테스트 (`e2e/budget-workflow.spec.ts`)
```typescript
import { test, expect } from '@playwright/test'

test.describe('Budget Workflow', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login')
    await page.fill('input[name="email"]', 'finance@example.com')
    await page.fill('input[name="password"]', 'finance123')
    await page.click('button[type="submit"]')
  })

  test('should prevent budget overrun', async ({ page }) => {
    await page.goto('/finance/budget')
    
    // Create budget
    await page.click('button:has-text("예산 편성")')
    await page.selectOption('select[name="category"]', 'PERSONNEL')
    await page.fill('input[name="amount"]', '10000000')
    await page.click('button[type="submit"]')
    
    // Try to spend more than budget
    await page.click('button:has-text("집행")')
    await page.fill('input[name="spent"]', '15000000')  // Over budget
    await page.click('button[type="submit"]')
    
    // Should show error
    await expect(page.locator('text=예산 초과')).toBeVisible()
  })
})
```

##### AI 챗봇 테스트 (`e2e/ai-chat.spec.ts`)
```typescript
import { test, expect } from '@playwright/test'

test.describe('AI Chat', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login')
    await page.fill('input[name="email"]', 'user@example.com')
    await page.fill('input[name="password"]', 'user123')
    await page.click('button[type="submit"]')
  })

  test('should get answer from AI chatbot', async ({ page }) => {
    await page.goto('/ai-chat')
    
    // Type question
    await page.fill('input[placeholder="질문을 입력하세요"]', '연차 규정은?')
    await page.click('button[type="submit"]')
    
    // Should show answer
    await expect(page.locator('text=연차 휴가는')).toBeVisible({ timeout: 10000 })
    
    // Should show confidence
    await expect(page.locator('text=신뢰도')).toBeVisible()
  })
})
```

#### 1.3 E2E 테스트 실행

```bash
# 모든 테스트 실행
pnpm exec playwright test

# 특정 브라우저만
pnpm exec playwright test --project=chromium

# 헤드 모드 (UI 보이게)
pnpm exec playwright test --headed

# 디버그 모드
pnpm exec playwright test --debug

# 결과 리포트 확인
pnpm exec playwright show-report
```

---

### 2. CI/CD 파이프라인 통합

#### 2.1 GitHub Actions Workflow

`.github/workflows/e2e-test.yml`:
```yaml
name: E2E Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps
      
      - name: Start Services
        run: |
          cd dev-environment
          docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d
          sleep 30  # Wait for services to be ready
      
      - name: Run E2E tests
        run: pnpm exec playwright test
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      
      - name: Stop Services
        if: always()
        run: |
          cd dev-environment
          docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml down
```

#### 2.2 GitLab CI Pipeline

`.gitlab-ci.yml`:
```yaml
stages:
  - test
  - deploy

e2e-test:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-jammy
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - npm install -g pnpm
    - pnpm install
  script:
    - cd dev-environment
    - docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d
    - sleep 30
    - cd ..
    - pnpm exec playwright test
  after_script:
    - cd dev-environment
    - docker compose down
  artifacts:
    when: always
    paths:
      - playwright-report/
    expire_in: 1 week
  only:
    - merge_requests
    - main
```

---

### 3. 운영 환경 배포

#### 3.1 Blue-Green Deployment Script

`scripts/deploy-blue-green.sh`:
```bash
#!/bin/bash
set -e

ENVIRONMENT=${1:-production}
VERSION=${2:-latest}

echo "🚀 Starting Blue-Green Deployment for $ENVIRONMENT (version: $VERSION)"

# Current active environment
CURRENT=$(docker ps --filter "name=web-admin-blue" --format "{{.Names}}" | head -n 1)
if [ -n "$CURRENT" ]; then
    ACTIVE="blue"
    INACTIVE="green"
else
    ACTIVE="green"
    INACTIVE="blue"
fi

echo "Current active: $ACTIVE"
echo "Deploying to: $INACTIVE"

# Deploy to inactive environment
echo "📦 Deploying to $INACTIVE environment..."
docker compose -f docker-compose.prod.yml up -d \
    --scale web-admin-$INACTIVE=1 \
    --scale web-admin-$ACTIVE=1

echo "⏳ Waiting for health check..."
sleep 10

# Health check
HEALTH_URL="http://localhost:420${INACTIVE:0:1}/health"
for i in {1..30}; do
    if curl -f $HEALTH_URL > /dev/null 2>&1; then
        echo "✅ Health check passed!"
        break
    fi
    echo "Waiting for service to be ready... ($i/30)"
    sleep 2
done

# Switch traffic (update nginx/load balancer)
echo "🔄 Switching traffic to $INACTIVE..."
# This would update your load balancer config
# For local testing, just swap the port forwarding

# Stop old environment
echo "🛑 Stopping $ACTIVE environment..."
docker compose -f docker-compose.prod.yml stop web-admin-$ACTIVE

echo "✅ Deployment complete! Active environment: $INACTIVE"
```

#### 3.2 Canary Deployment Script

`scripts/deploy-canary.sh`:
```bash
#!/bin/bash
set -e

VERSION=$1
CANARY_PERCENTAGE=${2:-10}  # Default 10%

echo "🐤 Starting Canary Deployment (version: $VERSION, traffic: $CANARY_PERCENTAGE%)"

# Deploy canary
docker compose -f docker-compose.prod.yml up -d \
    --scale web-admin-stable=9 \
    --scale web-admin-canary=1

echo "⏳ Monitoring canary for 5 minutes..."
sleep 300

# Check metrics
ERROR_RATE=$(curl -s "http://localhost:9090/api/v1/query?query=rate(http_requests_total{status=~\"5..\"}[5m])" | jq '.data.result[0].value[1]')
echo "Error rate: $ERROR_RATE"

if (( $(echo "$ERROR_RATE < 0.01" | bc -l) )); then
    echo "✅ Canary healthy! Promoting to 100%..."
    docker compose -f docker-compose.prod.yml up -d \
        --scale web-admin-stable=0 \
        --scale web-admin-canary=10
    echo "🎉 Deployment successful!"
else
    echo "❌ Canary unhealthy! Rolling back..."
    docker compose -f docker-compose.prod.yml up -d \
        --scale web-admin-stable=10 \
        --scale web-admin-canary=0
    exit 1
fi
```

#### 3.3 Rollback Script

`scripts/rollback.sh`:
```bash
#!/bin/bash
set -e

PREVIOUS_VERSION=$1

if [ -z "$PREVIOUS_VERSION" ]; then
    echo "Usage: ./rollback.sh <previous-version>"
    exit 1
fi

echo "⏪ Rolling back to version: $PREVIOUS_VERSION"

# Pull previous image
docker pull all-erp/web-admin:$PREVIOUS_VERSION

# Update and restart
docker compose -f docker-compose.prod.yml up -d --force-recreate

echo "✅ Rollback complete! Currently running version: $PREVIOUS_VERSION"
```

---

### 4. 운영 문서 작성

#### 4.1 배포 절차 매뉴얼

`docs/operations/deployment-procedure.md`:
```markdown
# 배포 절차 매뉴얼

## 사전 준비

1. **백업 수행**
   ```bash
   docker exec postgres pg_dump -U postgres all_erp > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **버전 확인**
   ```bash
   git tag -l
   git checkout v1.0.0
   ```

3. **빌드 및 테스트**
   ```bash
   pnpm nx run-many --target=build --all
   pnpm nx run-many --target=test --all
   pnpm exec playwright test
   ```

## 배포 단계

1. **Blue-Green 배포 실행**
   ```bash
   ./scripts/deploy-blue-green.sh production v1.0.0
   ```

2. **Health Check 확인**
   ```bash
   curl http://production.all-erp.com/health
   ```

3. **Smoke Test**
   - 로그인 테스트
   - 주요 기능 수동 확인
   - 에러 로그 확인

4. **모니터링**
   - Grafana: CPU, 메모리, 응답 시간 확인
   - Kibana: 에러 로그 모니터링
   - 15분간 모니터링 후 이상 없으면 완료

## 롤백 기준

다음 중 하나라도 발생 시 즉시 롤백:
- 5xx 에러율 > 1%
- 평균 응답 시간 > 2초
- CPU 사용률 > 90%
- Critical 에러 발생

## 롤백 절차

```bash
./scripts/rollback.sh v0.9.0
```
```

#### 4.2 장애 대응 매뉴얼

`docs/operations/incident-response.md`:
```markdown
# 장애 대응 매뉴얼

## 1단계: 장애 감지

### 모니터링 체크리스트
- [ ] Grafana 알림 확인
- [ ] Kibana 에러 로그 확인
- [ ] Jaeger 트레이싱 확인
- [ ] Database 연결 상태 확인

## 2단계: 영향 범위 파악

### 확인 사항
- 영향받는 서비스
- 영향받는 사용자 수
- 데이터 손실 여부

## 3단계: 즉시 조치

### 서비스 재시작
```bash
docker compose restart <service-name>
```

### 데이터베이스 연결 확인
```bash
docker exec postgres psql -U postgres -c "SELECT 1"
```

### 로그 수집
```bash
docker logs <service-name> --tail 1000 > incident_$(date +%Y%m%d_%H%M%S).log
```

## 4단계: 근본 원인 분석

### 로그 분석
```bash
# Kibana에서 검색
level:ERROR AND @timestamp:[now-1h TO now]
```

### 메트릭 분석
- CPU/메모리 스파이크 확인
- 느린 쿼리 확인
- 네트워크 이슈 확인

## 5단계: 재발 방지

- 사후 보고서 작성
- 모니터링 임계치 조정
- 코드 수정 및 배포
```

---

### 5. 사용자 매뉴얼

#### 5.1 사용자 가이드

`docs/user-manual/getting-started.md`:
```markdown
# All-ERP 사용자 가이드

## 시작하기

### 로그인
1. 브라우저에서 https://all-erp.company.com 접속
2. 이메일과 비밀번호 입력
3. "로그인" 버튼 클릭

![로그인 화면](../assets/screenshots/login.png)

### 대시보드
로그인 후 대시보드에서 주요 지표를 확인할 수 있습니다.

- **총 직원 수**: 현재 재직 중인 직원 수
- **예산 집행률**: 연간 예산 대비 집행률
- **이번 달 매출**: 당월 총 매출액
- **미처리 알림**: 확인이 필요한 알림 개수

## 주요 기능

### 인사 관리
1. 좌측 메뉴에서 "인사관리" 클릭
2. "직원 등록" 버튼 클릭
3. 직원 정보 입력:
   - 이름
   - 이메일
   - 부서
   - 직급
   - 급여
   - 입사일
4. "저장" 버튼 클릭

### 예산 관리
1. "재무회계" > "예산 관리" 메뉴 선택
2. "예산 편성" 버튼 클릭
3. 예산 정보 입력:
   - 부서 또는 항목 선택
   - 예산액 입력
   - 회계연도 선택
4. "저장" 버튼 클릭

### AI 챗봇
1. 우측 하단의 챗봇 아이콘 클릭
2. 궁금한 사항 입력 (예: "연차 규정은?")
3. AI가 사내 규정을 검색하여 답변 제공

## 문제 해결

### 로그인이 안 돼요
- 이메일과 비밀번호를 다시 확인하세요
- Caps Lock이 켜져있는지 확인하세요
- 비밀번호를 잊으셨다면 관리자에게 문의하세요

### 페이지가 느려요
- 브라우저를 새로고침하세요 (F5)
- 브라우저 캐시를 삭제해보세요
- 그래도 안 되면 IT 팀에 문의하세요
```

---

## 최종 배포 체크리스트

### 배포 전
- [ ] 모든 단위 테스트 통과
- [ ] E2E 테스트 100% 통과
- [ ] 보안 스캔 (HIGH 이상 취약점 0개)
- [ ] 부하 테스트 통과 (100명 동시 사용자)
- [ ] 데이터베이스 백업 완료
- [ ] 롤백 계획 수립

### 배포 중
- [ ] Blue-Green 배포 실행
- [ ] Health Check 통과
- [ ] Smoke Test 통과
- [ ] 모니터링 대시보드 확인

### 배포 후
- [ ] 24시간 모니터링
- [ ] 사용자 피드백 수집
- [ ] 에러 로그 확인 (Critical 0건)
- [ ] 성능 메트릭 확인
- [ ] 사후 보고서 작성

---

## Why This Matters (중요성)

### 1. E2E 테스트로 사용자 경험 보장
실제 사용자 시나리오를 자동화하여, 배포 전에 주요 기능이 정상 동작하는지 검증합니다.

### 2. Blue-Green 배포로 무중단 서비스
새 버전을 병렬로 배포하고 Health Check 후 트래픽을 전환하여, 사용자에게 다운타임 없이 서비스합니다.

### 3. 롤백 계획으로 빠른 복구
배포 실패 시 스크립트 하나로 이전 버전으로 즉시 롤백하여, 서비스 중단 시간을 최소화합니다.

### 4. 운영 문서로 팀 역량 강화
배포 절차와 장애 대응 매뉴얼을 문서화하여, 누구나 표준화된 프로세스를 따를 수 있습니다.

### 5. 사용자 매뉴얼로 셀프 서비스 지원
기능별 사용 가이드를 제공하여 사용자가 스스로 문제를 해결하고, 헬프데스크 부담을 줄입니다.

---

## Next Steps (운영 최적화)

1. **자동화 확대**: 배포부터 롤백까지 완전 자동화
2. **카나리 배포 도입**: 점진적 트래픽 전환으로 리스크 최소화
3. **Feature Flag**: 코드 배포와 기능 활성화 분리
4. **A/B 테스트**: 신기능 효과 측정
5. **ChatOps**: Slack에서 배포 명령 실행
