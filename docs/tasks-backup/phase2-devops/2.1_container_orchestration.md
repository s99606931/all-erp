# PRD: 컨테이너 및 오케스트레이션 환경 구축

## 1. 개요 (Overview)
- **Task ID**: 2.1_container_orchestration
- **목표**: 모든 마이크로서비스를 컨테이너화하고, 로컬 개발 및 운영 환경을 위한 오케스트레이션 구성을 완료합니다.
- **관련 로드맵**: Phase 2 - 컨테이너 및 오케스트레이션

## 2. 상세 요구사항 (Requirements)
- [ ] **Dockerfile 작성**: NestJS(백엔드) 및 Next.js(프론트엔드)를 위한 최적화된 Dockerfile 작성 (Multi-stage build 적용)
- [ ] **Docker Compose 구성**: 로컬 개발 시 DB(PostgreSQL), Cache(Redis), MQ(RabbitMQ) 및 모든 서비스를 한 번에 띄울 수 있는 `docker-compose.yml` 작성
- [ ] **Kubernetes Manifests**: 운영 배포를 위한 Helm Chart 기본 구조 설계

## 3. 기술적 의사결정 (Technical Decisions)

### 3.1 Docker Image 최적화
- **Base Image**: `node:22-alpine` (2024년 10월부터 LTS, 경량화)
- **Build Strategy**: **Multi-stage Build**
    - `builder`: 의존성 설치 및 빌드 (`pnpm install`, `nx build`)
    - `runner`: 프로덕션 의존성만 복사 및 실행 (`node dist/apps/.../main.js`)
    - **이점**: 이미지 크기 최소화(~100MB), 보안 강화, 빌드 캐시 활용

### 3.2 로컬 개발 환경 (Local Dev)
- **선택지 A**: 모든 서비스를 Docker로 실행
- **선택지 B**: 인프라(DB, MQ)만 Docker로 실행하고, 앱은 로컬(`nx serve`)로 실행
- **✅ 권장사항**: **Hybrid 접근**
    - `docker-compose.infra.yml`: DB, Redis, RabbitMQ 등 인프라만 실행 (개발 시 주로 사용)
    - `docker-compose.yml`: 전체 서비스 실행 (통합 테스트 시 사용)

### 3.3 Container Registry
- **선택**: **GitLab Container Registry** (자체 호스팅)
    - 이미지 푸시: `registry.all-erp.local/project-name/service-name:tag`
    - GitLab CI/CD와 자동 통합
    - 통합 인증 (GitLab 계정으로 로그인)

## 4. 작업 단위 (Work Breakdown)

> **참고**: 컨테이너 환경은 이미 다음 파일들로 구성되어 있습니다:
> - [docker-compose.infra.yml](../../dev-environment/docker-compose.infra.yml): 인프라 서비스 (PostgreSQL, Redis, RabbitMQ, Milvus, Minio, Etcd)
> - [docker-compose.dev.yml](../../dev-environment/docker-compose.dev.yml): 개발 환경 (볼륨 마운트 + Hot Reload)
> - [docker-compose.prod.yml](../../dev-environment/docker-compose.prod.yml): 운영 환경 (빌드된 이미지)
> - [Dockerfile.dev](../../Dockerfile.dev): 개발용 멀티스테이지 빌드

1.  **Dockerfile 최적화 검토**:
    - `Dockerfile.dev`: 개발 환경용 (이미 존재)
    - `Dockerfile.prod`: 운영 환경용 Multi-stage build 작성 필요 시
    
2.  **Docker Compose 확인 및 테스트**:
    ```bash
    # 인프라 + 개발 환경 전체 실행
    cd dev-environment
    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d
    
    # 로그 확인
    docker compose logs -f auth-service
    
    # 전체 중지
    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml down
    ```

3.  **GitLab Container Registry 연동 설정**:
    ```bash
    # GitLab Registry 로그인
    docker login registry.all-erp.local:5050
    # Username: your-gitlab-username
    # Password: your-personal-access-token
    
    # 이미지 빌드 및 푸시
    docker build -f Dockerfile.dev -t registry.all-erp.local:5050/all-erp/auth-service:latest .
    docker push registry.all-erp.local:5050/all-erp/auth-service:latest
    ```

4.  **Helm Chart 기본 구조 설계** (선택 사항, Phase 3에서 진행 가능)

> **참고**: [Docker-First Workflow Guide](../../guides/docker-first-workflow.md)

## 5. 승인 기준 (Acceptance Criteria)
- [ ] **Docker Compose 실행**: `docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d` 명령어로 모든 서비스가 정상 실행
- [ ] **이미지 최적화**: Docker Image 크기가 최적화되어 불필요한 소스 코드 제외
- [ ] **Hot Reload 동작**: 로컬에서 소스 코드 수정 시 컨테이너 내부에서 자동 재시작
