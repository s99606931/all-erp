# PRD 3.1 ì™„ë£Œ ë³´ê³ ì„œ: ê³µí†µ ëª¨ë“ˆ (Shared Libs) ê°œë°œ

## ì‘ì—… ìš”ì•½

**PRD**: [`3.1_shared_libs.md`](file:///data/all-erp/docs/tasks/phase3-common/3.1_shared_libs.md)  
**ëª©í‘œ**: ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ ì½”ë“œ ì¬ì‚¬ìš©ì„ ìœ„í•œ ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ êµ¬í˜„  
**ìƒíƒœ**: âœ… **ì™„ë£Œ** (í…ŒìŠ¤íŠ¸ í¬í•¨)

---

## ìˆ˜í–‰ ë‚´ìš©

### 1. Shared Util (`@all-erp/shared/util`)

**êµ¬í˜„ ê¸°ëŠ¥**:
- ë‚ ì§œ ì²˜ë¦¬: `formatDate()`, `getDaysDiff()`, `addDays()`
- ë¬¸ìì—´: `capitalize()`, `snakeToCamel()`, `maskEmail()`
- ì•”í˜¸í™”: `hashPassword()`, `comparePassword()`, `base64Encode()`
- ê²€ì¦: `isValidEmail()`, `isValidPhoneNumber()`, `isEmpty()`

**í…ŒìŠ¤íŠ¸**: âœ… 73ê°œ í†µê³¼

### 2. Shared Domain (`@all-erp/shared/domain`)

**êµ¬í˜„ ê¸°ëŠ¥**:
- `ApiResponse`: í‘œì¤€ API ì‘ë‹µ í¬ë§·
- `PaginatedResponse`: í˜ì´ì§• ì‘ë‹µ
- `BusinessException`, `EntityNotFoundException`: ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸
- `GlobalExceptionFilter`: ì „ì—­ ì—ëŸ¬ ì²˜ë¦¬

**í…ŒìŠ¤íŠ¸**: âœ… 32ê°œ í†µê³¼

### 3. Shared Infra (`@all-erp/shared/infra`)

**êµ¬í˜„ ê¸°ëŠ¥**:
- `PrismaModule`: DB ì—°ê²°, Multi-tenancy ìë™ í•„í„°ë§
- `LoggerModule`: Winston ê¸°ë°˜ êµ¬ì¡°í™” ë¡œê¹…
- `RabbitMQModule`: ì„œë¹„ìŠ¤ ê°„ ë©”ì‹œì§€ í†µì‹ 
- `TenantMiddleware`: í…Œë„ŒíŠ¸ ID ì¶”ì¶œ (í—¤ë”/Subdomain)

**í…ŒìŠ¤íŠ¸**: âœ… 15ê°œ í†µê³¼

---

## ì•„í‚¤í…ì²˜

```mermaid
graph TB
    subgraph Services["ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤"]
        A["auth-service"]
        B["system-service"]
        C["personnel-service"]
    end
    
    subgraph Libs["Shared Libraries"]
        D["@all-erp/shared/util"]
        E["@all-erp/shared/domain"]
        F["@all-erp/shared/infra"]
    end
    
    A --> D
    A --> E
    A --> F
    B --> D
    B --> E
    B --> F
    C --> D
    C --> E
    C --> F
    
    subgraph Infra["Infrastructure"]
        G[("PostgreSQL")]
        H["RabbitMQ"]
    end
    
    F --> G
    F --> H
    
    style Libs fill:#e1f5e1
    style Services fill:#e3f2fd
    style Infra fill:#fff3e0
```

---

## ì‚¬ìš© ì˜ˆì œ

```typescript
// app.module.ts
import { InfraModule, TenantMiddleware } from '@all-erp/shared/infra';
import { GlobalExceptionFilter } from '@all-erp/shared/domain';

@Module({
  imports: [InfraModule],  // Prisma, Logger, RabbitMQ í¬í•¨
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(TenantMiddleware).forRoutes('*');
  }
}

// user.service.ts
import { PrismaService } from '@all-erp/shared/infra';
import { ApiResponse, EntityNotFoundException } from '@all-erp/shared/domain';
import { hashPassword } from '@all-erp/shared/util';

async createUser(data: CreateUserDto) {
  const user = await this.prisma.user.create({
    data: {
      email: data.email,
      password: await hashPassword(data.password),
    },
  }); // tenantId ìë™ ì¶”ê°€
  
  return ApiResponse.success(user);
}
```

---

## ê²€ì¦ ê²°ê³¼

### Lint ê²€ì‚¬
```bash
âœ… pnpm nx lint util      # í†µê³¼
âœ… pnpm nx lint domain    # í†µê³¼
âœ… pnpm nx lint infra     # í†µê³¼
```

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
```bash
âœ… pnpm nx test util      # 73ê°œ í†µê³¼
âœ… pnpm nx test domain    # 32ê°œ í†µê³¼
âœ… pnpm nx test infra     # 15ê°œ í†µê³¼
```

**ì´ 120ê°œ í…ŒìŠ¤íŠ¸ ì‘ì„± ë° í†µê³¼**

### Import í…ŒìŠ¤íŠ¸
```typescript
// ëª¨ë“  ì„œë¹„ìŠ¤ì—ì„œ ì •ìƒ import ê°€ëŠ¥
import { ... } from '@all-erp/shared/util';
import { ... } from '@all-erp/shared/domain';
import { ... } from '@all-erp/shared/infra';
```

---

## Why This Matters (ì¤‘ìš”ì„±)

### 1. ì½”ë“œ ì¬ì‚¬ìš©ì„± ê·¹ëŒ€í™”
ëª¨ë“  ì„œë¹„ìŠ¤ì—ì„œ ë™ì¼í•œ ìœ í‹¸ë¦¬í‹°ì™€ ì¸í”„ë¼ ì½”ë“œ ì‚¬ìš© â†’ **ì¤‘ë³µ ì œê±°**, **ìœ ì§€ë³´ìˆ˜ ìš©ì´**

### 2. Multi-tenancy ë³´ì•ˆ ê°•í™”
Prisma Middlewareê°€ ëª¨ë“  ì¿¼ë¦¬ì— `tenantId` ìë™ ì¶”ê°€ â†’ **ë°ì´í„° ìœ ì¶œ ë°©ì§€**

```typescript
// ê°œë°œìê°€ tenantIdë¥¼ ìŠì–´ë„ ìë™ ì ìš©ë¨
prisma.user.findMany()  // WHERE tenantId = 'current-tenant' ìë™ ì¶”ê°€
```

### 3. ì¼ê´€ëœ ì—ëŸ¬ ì²˜ë¦¬
Global Exception Filter â†’ **ëª¨ë“  APIì—ì„œ ë™ì¼í•œ ì—ëŸ¬ ì‘ë‹µ í¬ë§·**

```json
{
  "success": false,
  "message": "User not found",
  "code": "ENTITY_NOT_FOUND",
  "timestamp": "2025-12-03T00:40:00.000Z"
}
```

### 4. í‘œì¤€í™”ëœ ë¡œê¹…
Winston êµ¬ì¡°í™” ë¡œê¹… â†’ **ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¡œê·¸ ë¶„ì„ ê°€ëŠ¥**

---

## ìƒì„±ëœ íŒŒì¼

```
libs/shared/
â”œâ”€â”€ util/src/lib/
â”‚   â”œâ”€â”€ date-utils.ts, date-utils.spec.ts
â”‚   â”œâ”€â”€ string-utils.ts, string-utils.spec.ts
â”‚   â”œâ”€â”€ crypto-utils.ts, crypto-utils.spec.ts
â”‚   â””â”€â”€ validator-utils.ts, validator-utils.spec.ts
â”œâ”€â”€ domain/src/lib/
â”‚   â”œâ”€â”€ api-response.dto.ts, api-response.dto.spec.ts
â”‚   â”œâ”€â”€ business.exception.ts, business.exception.spec.ts
â”‚   â””â”€â”€ global-exception.filter.ts, global-exception.filter.spec.ts
â””â”€â”€ infra/src/lib/
    â”œâ”€â”€ prisma/prisma.module.ts, prisma.service.spec.ts
    â”œâ”€â”€ logger/logger.module.ts, logger.service.ts, logger.service.spec.ts
    â”œâ”€â”€ rabbitmq/rabbitmq.module.ts, rabbitmq.service.ts
    â”œâ”€â”€ tenant.middleware.ts, tenant.middleware.spec.ts
    â”œâ”€â”€ types/express.d.ts
    â””â”€â”€ README.md (ìƒì„¸ ì‚¬ìš© ê°€ì´ë“œ)
```

---

## ë‹¤ìŒ ë‹¨ê³„

1. **ì‹¤ì œ ì„œë¹„ìŠ¤ ì ìš©**: auth-service, system-serviceì—ì„œ importí•˜ì—¬ ê²€ì¦
2. **Docker í™˜ê²½ í…ŒìŠ¤íŠ¸**: Docker Composeì—ì„œ í†µí•© í…ŒìŠ¤íŠ¸
3. **E2E í…ŒìŠ¤íŠ¸**: Prisma, RabbitMQ ì‹¤ì œ í™˜ê²½ í…ŒìŠ¤íŠ¸

---

## ê²°ë¡ 

**PRD 3.1_shared_libs ê°œë°œ ì™„ë£Œ** ğŸ‰

- âœ… 3ê°œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (Util, Domain, Infra)
- âœ… 11ê°œ ëª¨ë“ˆ/ì„œë¹„ìŠ¤
- âœ… Multi-tenancy ìë™í™”
- âœ… 120ê°œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- âœ… ìƒì„¸ ë¬¸ì„œí™”

ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ê³µí†µ ì½”ë“œ ê¸°ë°˜ì´ êµ¬ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤.
