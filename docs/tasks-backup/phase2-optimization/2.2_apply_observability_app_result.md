# Result: ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ì¸¡ì„± ì ìš© (Apply Observability to Apps)

## 1. ê°œìš” (Overview)
**Task**: `docs/tasks/phase2-optimization/2.2_apply_observability_app.md`
**Status**: âœ… ì™„ë£Œ (Completed)
**Date**: 2025-12-07

ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ê°€ ë³„ë„ì˜ ì½”ë“œ ìˆ˜ì • ì—†ì´ **ìë™ìœ¼ë¡œ ê´€ì¸¡ì„± ë°ì´í„°(Log, Trace)ë¥¼ ì „ì†¡**í•˜ë„ë¡ `libs/shared/infra`ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. ì´ì œ ì•±ì„ ì‹¤í–‰í•˜ë©´ ìë™ìœ¼ë¡œ OpenTelemetryê°€ ì´ˆê¸°í™”ë˜ê³  Lokië¡œ ë¡œê·¸ê°€ ì „ì†¡ë©ë‹ˆë‹¤.

## 2. ë³€ê²½ ì‚¬í•­ (Changes)

### 2.1 ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜
`package.json`ì— ë‹¤ìŒ ì˜ì¡´ì„±ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
- **OpenTelemetry**: `@opentelemetry/sdk-node`, `@opentelemetry/auto-instrumentations-node` ë“±
- **NestJS**: `nestjs-otel`
- **Logging**: `winston-loki`

### 2.2 ğŸ›¡ï¸ Shared Infra ê³ ë„í™”
1.  **OpenTelemetry SDK êµ¬í˜„** (`libs/shared/infra/src/lib/observability/otel.sdk.ts`)
    - NodeSDKë¥¼ í†µí•´ íŠ¸ë ˆì´ì‹± ìë™ ì‹œì‘.
    - OTLP Exporterë¥¼ í†µí•´ **Tempo(4317)**ë¡œ íŠ¸ë ˆì´ìŠ¤ ë°ì´í„° ì „ì†¡.
2.  **Loki Transport ì¶”ê°€** (`libs/shared/infra/src/lib/logger/winston.config.ts`)
    - `winston-loki`ë¥¼ ì‚¬ìš©í•˜ì—¬ **Loki(3100)**ë¡œ ë¡œê·¸ ì „ì†¡.
    - ë¡œê·¸ì— `service` ë ˆì´ë¸” ìë™ ì¶”ê°€.
3.  **Bootstrap ìë™í™”** (`libs/shared/infra/src/lib/bootstrap/bootstrap.ts`)
    - ì„œë¹„ìŠ¤ ì‹œì‘ ì‹œ `initOpenTelemetry(serviceName)` ìë™ í˜¸ì¶œ.
    - ê°œë°œìê°€ ë³„ë„ë¡œ ì„¤ì •í•  í•„ìš” ì—†ì´ `bootstrapService`ë§Œ ì“°ë©´ ì ìš©ë¨.

## 3. ë°ì´í„° íë¦„ (Data Flow)

```mermaid
flowchart LR
    subgraph Microservice ["Any Microservice (e.g. Auth)"]
        Bootstrap["bootstrapService()"] --> OTel["initOpenTelemetry()"]
        Bootstrap --> Winston["Winston Logger"]
    end

    OTel -- "Traces (gRPC)" --> Tempo["Tempo (4317)"]
    Winston -- "Logs (HTTP)" --> Loki["Loki (3100)"]
    
    Tempo --> Grafana
    Loki --> Grafana
```

## 4. ê²€ì¦ ë° í™•ì¸ (Verification)

### 1ï¸âƒ£ ì„œë¹„ìŠ¤ ì‹¤í–‰
```bash
./erp start auth-service
```
ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë  ë•Œ ë¡œê·¸ì— `ğŸ“¡ [OpenTelemetry] Started for service: auth-service`ê°€ ì°íˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

### 2ï¸âƒ£ Grafana í™•ì¸
- **Loki**: Explore > Loki > `{service="auth-service"}` ì¿¼ë¦¬ë¡œ ë¡œê·¸ í™•ì¸.
- **Tempo**: Explore > Tempo > Service Graph ë˜ëŠ” Trace IDë¡œ ê²€ìƒ‰.
