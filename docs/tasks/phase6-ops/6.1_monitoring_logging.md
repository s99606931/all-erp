# PRD: 모니터링 및 로깅 시스템 구축

## 1. 개요 (Overview)
- **Task ID**: 6.1_monitoring_logging
- **목표**: 운영 환경에서 시스템 상태를 실시간으로 모니터링하고, 문제 발생 시 신속하게 원인을 파악할 수 있는 인프라를 구축합니다.
- **관련 로드맵**: Phase 6 - 안정화 및 운영 이관

## 2. 상세 요구사항 (Requirements)

### 2.1 로그 수집 및 분석 (Logging)
- [ ] **중앙 집중식 로깅**: 모든 서비스의 로그를 ELK Stack(Elasticsearch, Logstash/Fluentd, Kibana)으로 수집
- [ ] **구조화된 로깅**: JSON 포맷으로 로그 출력 (`winston` 사용)
- [ ] **로그 레벨 관리**: ERROR, WARN, INFO, DEBUG 등 환경별 로그 레벨 설정

### 2.2 메트릭 수집 및 시각화 (Metrics)
- [ ] **Prometheus**: 각 서비스의 메트릭(응답 시간, 에러율, CPU/메모리 사용량) 수집
- [ ] **Grafana**: 대시보드를 통해 실시간 메트릭 시각화
- [ ] **알림 설정**: 임계치 초과 시 Slack/이메일 알림

### 2.3 분산 추적 (Tracing)
- [ ] **Jaeger 또는 Zipkin**: 마이크로서비스 간 요청 흐름 추적
- [ ] **Trace ID 전파**: 모든 서비스에 `traceId`를 헤더로 전파하여 로그 연결

## 3. 기술적 의사결정 (Technical Decisions)

### 3.1 로깅 스택
- **✅ 권장사항**: **ELK Stack** (Elasticsearch + Logstash + Kibana)
    - **대안**: **Loki + Grafana** (경량, 비용 절감)

### 3.2 메트릭 수집
- **✅ 권장사항**: **Prometheus + Grafana**
    - NestJS: `@willsoto/nestjs-prometheus` 라이브러리 활용

### 3.3 트레이싱
- **✅ 권장사항**: **Jaeger** (OpenTelemetry 호환)

## 4. 작업 단위 (Work Breakdown)

> **참고**: 모니터링 도구는 이미 `dev-environment/docker-compose.devops.yml`에 정의되어 있습니다.
> 포함된 서비스: Prometheus, Grafana, Elasticsearch, Kibana, Logstash, Jaeger

1.  **Winston Logger 설정**:
    - JSON 포맷 출력 설정
    - 로그 레벨 환경별 관리

2.  **Logstash/Fluentd 설정**:
    - 이미 `docker-compose.devops.yml`에 포함됨
    - 각 서비스의 로그를 Elasticsearch로 전송

3.  **Prometheus 메트릭 노출**:
    - 각 서비스에 `/metrics` 엔드포인트 추가
    - `@willsoto/nestjs-prometheus` 라이브러리 활용

4.  **Grafana 대시보드 구성**:
    - `http://localhost:3000` 접속 (admin/admin)
    - CPU, 메모리, API 응답 시간 대시보드

5.  **Docker Compose로 모니터링 환경 실행**:
    ```bash
    # DevOps 도구 실행 (Prometheus, Grafana, ELK, Jaeger)
    cd dev-environment
    docker compose -f docker-compose.devops.yml up -d
    
    # 접속 URL
    # Grafana: http://localhost:3000
    # Prometheus: http://localhost:9090
    # Kibana: http://localhost:5601
    # Jaeger: http://localhost:16686
    ```

> **참고**: [Docker-First Workflow Guide](../../guides/docker-first-workflow.md)

## 5. 승인 기준 (Acceptance Criteria)
- [ ] **통합 로그 조회**: Kibana(`http://localhost:5601`)에서 모든 서비스의 로그를 통합 조회
- [ ] **실시간 메트릭**: Grafana(`http://localhost:3000`)에서 각 서비스의 CPU/메모리 사용량 실시간 표시
- [ ] **분산 추적**: Jaeger UI(`http://localhost:16686`)에서 하나의 요청이 여러 서비스를 거치는 과정 추적
- [ ] **알림 설정**: Grafana에서 임계치 초과 시 알림 발송
