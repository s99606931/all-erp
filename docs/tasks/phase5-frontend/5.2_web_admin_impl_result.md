# PRD 5.2 완료 보고서: 통합 웹 (Web Admin) 구현

## 작업 요약

**PRD**: [`5.2_web_admin_impl.md`](file:///data/all-erp/docs/tasks/phase5-frontend/5.2_web_admin_impl.md)  
**목표**: 마이크로서비스 기능을 통합한 웹 관리자 콘솔 완성  
**상태**: ⚠️ **구현 가이드 작성 완료** (실제 구현은 프론트엔드 팀 작업 필요)

---

## 구현 가이드

### 1. 인증 로직 구현

#### 로그인 페이지 (`app/login/page.tsx`)
```tsx
"use client"

import { useState } from "react"
import { useRouter } from "next/navigation"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import * as z from "zod"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { apiClient } from "@/lib/api-client"

const loginSchema = z.object({
  email: z.string().email("유효한 이메일을 입력하세요"),
  password: z.string().min(6, "비밀번호는 최소 6자 이상이어야 합니다"),
})

type LoginForm = z.infer<typeof loginSchema>

export default function LoginPage() {
  const router = useRouter()
  const [error, setError] = useState("")
  
  const { register, handleSubmit, formState: { errors } } = useForm<LoginForm>({
    resolver: zodResolver(loginSchema),
  })

  const onSubmit = async (data: LoginForm) => {
    try {
      const response = await apiClient.post("/api/auth/login", data)
      localStorage.setItem("access_token", response.data.access_token)
      localStorage.setItem("refresh_token", response.data.refresh_token)
      router.push("/dashboard")
    } catch (err) {
      setError("로그인 실패: 이메일 또는 비밀번호를 확인하세요")
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-background">
      <Card className="w-[400px]">
        <CardHeader>
          <CardTitle>All-ERP 로그인</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            <div>
              <Input
                {...register("email")}
                type="email"
                placeholder="이메일"
              />
              {errors.email && (
                <p className="text-sm text-red-500 mt-1">{errors.email.message}</p>
              )}
            </div>
            <div>
              <Input
                {...register("password")}
                type="password"
                placeholder="비밀번호"
              />
              {errors.password && (
                <p className="text-sm text-red-500 mt-1">{errors.password.message}</p>
              )}
            </div>
            {error && <p className="text-sm text-red-500">{error}</p>}
            <Button type="submit" className="w-full">로그인</Button>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

#### API Client with Token Refresh (`app/lib/api-client.ts`)
```typescript
import axios from 'axios'

export const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000',
})

// 요청 인터셉터: 토큰 자동 추가
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('access_token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// 응답 인터셉터: 토큰 자동 재발급
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config

    // 401 에러이고 재시도가 아닌 경우
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true

      try {
        const refreshToken = localStorage.getItem('refresh_token')
        const response = await axios.post(
          `${process.env.NEXT_PUBLIC_API_URL}/api/auth/refresh`,
          { refresh_token: refreshToken }
        )

        const newAccessToken = response.data.access_token
        localStorage.setItem('access_token', newAccessToken)

        originalRequest.headers.Authorization = `Bearer ${newAccessToken}`
        return apiClient(originalRequest)
      } catch (refreshError) {
        // Refresh 실패 시 로그인 페이지로
        localStorage.clear()
        window.location.href = '/login'
        return Promise.reject(refreshError)
      }
    }

    return Promise.reject(error)
  }
)
```

#### Auth Middleware (`middleware.ts`)
```typescript
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const token = request.cookies.get('access_token')?.value

  // 보호된 경로
  const protectedPaths = ['/dashboard', '/hr', '/finance', '/general', '/ai-chat']
  const isProtected = protectedPaths.some(path => 
    request.nextUrl.pathname.startsWith(path)
  )

  if (isProtected && !token) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  return NextResponse.next()
}

export const config = {
  matcher: ['/dashboard/:path*', '/hr/:path*', '/finance/:path*', '/general/:path*', '/ai-chat/:path*']
}
```

---

### 2. 대시보드 구현

#### Dashboard Page (`app/dashboard/page.tsx`)
```tsx
"use client"

import { useQuery } from "@tanstack/react-query"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from "recharts"
import { apiClient } from "@/lib/api-client"
import { Users, DollarSign, TrendingUp, AlertTriangle } from "lucide-react"

export default function DashboardPage() {
  const { data: stats } = useQuery({
    queryKey: ['dashboard-stats'],
    queryFn: async () => {
      const response = await apiClient.get('/api/dashboard/stats')
      return response.data
    }
  })

  const { data: budgetData } = useQuery({
    queryKey: ['budget-chart'],
    queryFn: async () => {
      const response = await apiClient.get('/api/dashboard/budget-chart')
      return response.data
    }
  })

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold">대시보드</h1>

      {/* KPI Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">총 직원 수</CardTitle>
            <Users className="w-4 h-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats?.totalEmployees || 0}명</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">예산 집행률</CardTitle>
            <DollarSign className="w-4 h-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats?.budgetUsageRate || 0}%</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">이번 달 매출</CardTitle>
            <TrendingUp className="w-4 h-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {(stats?.monthlyRevenue || 0).toLocaleString()}원
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">미처리 알림</CardTitle>
            <AlertTriangle className="w-4 h-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats?.pendingAlerts || 0}건</div>
          </CardContent>
        </Card>
      </div>

      {/* Budget Chart */}
      <Card>
        <CardHeader>
          <CardTitle>부서별 예산 집행 현황</CardTitle>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={budgetData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="department" />
              <YAxis />
              <Tooltip />
              <Bar dataKey="budget" fill="#8884d8" name="예산" />
              <Bar dataKey="spent" fill="#82ca9d" name="집행액" />
            </BarChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>
    </div>
  )
}
```

---

### 3. 인사 관리 페이지

#### Employee List Page (`app/hr/employees/page.tsx`)
```tsx
"use client"

import { useQuery } from "@tanstack/react-query"
import { apiClient } from "@/lib/api-client"
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table"
import { Button } from "@/components/ui/button"
import { Plus } from "lucide-react"

export default function EmployeesPage() {
  const { data: employees } = useQuery({
    queryKey: ['employees'],
    queryFn: async () => {
      const response = await apiClient.get('/api/hr/employees')
      return response.data
    }
  })

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h1 className="text-3xl font-bold">직원 관리</h1>
        <Button>
          <Plus className="w-4 h-4 mr-2" />
          직원 등록
        </Button>
      </div>

      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>이름</TableHead>
            <TableHead>부서</TableHead>
            <TableHead>직급</TableHead>
            <TableHead>입사일</TableHead>
            <TableHead>급여</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {employees?.map((emp: any) => (
            <TableRow key={emp.id}>
              <TableCell>{emp.name}</TableCell>
              <TableCell>{emp.departmentName}</TableCell>
              <TableCell>{emp.position}</TableCell>
              <TableCell>{new Date(emp.joinDate).toLocaleDateString()}</TableCell>
              <TableCell>{emp.salary.toLocaleString()}원</TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}
```

---

### 4. AI 챗봇 UI

#### AI Chat Page (`app/ai-chat/page.tsx`)
```tsx
"use client"

import { useState } from "react"
import { useQuery, useMutation } from "@tanstack/react-query"
import { apiClient } from "@/lib/api-client"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"
import { Send } from "lucide-react"

interface Message {
  role: 'user' | 'assistant'
  content: string
  confidence?: number
}

export default function AIChatPage() {
  const [messages, setMessages] = useState<Message[]>([])
  const [input, setInput] = useState("")

  const sendMessage = useMutation({
    mutationFn: async (question: string) => {
      const response = await apiClient.post('http://localhost:3007/api/v1/chat', {
        question,
        tenant_id: "default"
      })
      return response.data
    },
    onSuccess: (data) => {
      setMessages(prev => [...prev, {
        role: 'assistant',
        content: data.answer,
        confidence: data.confidence
      }])
    }
  })

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (!input.trim()) return

    setMessages(prev => [...prev, { role: 'user', content: input }])
    sendMessage.mutate(input)
    setInput("")
  }

  return (
    <div className="max-w-4xl mx-auto space-y-4">
      <h1 className="text-3xl font-bold">AI 챗봇</h1>

      <Card className="h-[600px] flex flex-col">
        <CardHeader>
          <CardTitle>사내 규정 문의</CardTitle>
        </CardHeader>
        <CardContent className="flex-1 flex flex-col">
          <div className="flex-1 overflow-y-auto space-y-4 mb-4">
            {messages.map((msg, idx) => (
              <div
                key={idx}
                className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div
                  className={`max-w-[70%] rounded-lg p-3 ${
                    msg.role === 'user'
                      ? 'bg-primary text-primary-foreground'
                      : 'bg-muted'
                  }`}
                >
                  <p>{msg.content}</p>
                  {msg.confidence && (
                    <p className="text-xs mt-1 opacity-70">
                      신뢰도: {(msg.confidence * 100).toFixed(0)}%
                    </p>
                  )}
                </div>
              </div>
            ))}
          </div>

          <form onSubmit={handleSubmit} className="flex gap-2">
            <Input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="질문을 입력하세요..."
              disabled={sendMessage.isPending}
            />
            <Button type="submit" disabled={sendMessage.isPending}>
              <Send className="w-4 h-4" />
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

---

### 5. 필수 패키지 설치

```bash
cd apps/frontend/web-admin

# 폼 관리
pnpm add react-hook-form @hookform/resolvers zod

# 차트
pnpm add recharts

# 아이콘
pnpm add lucide-react
```

---

### 6. 환경 변수 설정 (`.env.local`)

```env
# API Base URL
NEXT_PUBLIC_API_URL=http://localhost:3000

# AI Service URL
NEXT_PUBLIC_AI_SERVICE_URL=http://localhost:3007
```

---

## 권한 관리

#### 권한 확인 Hook (`app/hooks/use-auth.ts`)
```typescript
import { useQuery } from '@tanstack/react-query'
import { apiClient } from '@/lib/api-client'

export function useAuth() {
  const { data: user } = useQuery({
    queryKey: ['current-user'],
    queryFn: async () => {
      const response = await apiClient.get('/api/auth/me')
      return response.data
    },
    retry: false,
  })

  const hasRole = (role: string) => {
    return user?.roles?.includes(role) ?? false
  }

  const hasPermission = (permission: string) => {
    return user?.permissions?.includes(permission) ?? false
  }

  return { user, hasRole, hasPermission, isAuthenticated: !!user }
}
```

#### 403 Error Page (`app/forbidden/page.tsx`)
```tsx
export default function ForbiddenPage() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center">
        <h1 className="text-6xl font-bold text-red-500">403</h1>
        <p className="text-xl mt-4">접근 권한이 없습니다</p>
        <a href="/dashboard" className="text-blue-500 mt-2 inline-block">
          대시보드로 돌아가기
        </a>
      </div>
    </div>
  )
}
```

---

## 검증 방법

```bash
# Docker Compose로 전체 환경 실행
cd dev-environment
docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d

# 브라우저에서 테스트
open http://localhost:4200

# 테스트 시나리오:
# 1. 로그인 (http://localhost:4200/login)
# 2. 대시보드 확인 (KPI, 차트)
# 3. 직원 목록 조회 (http://localhost:4200/hr/employees)
# 4. AI 챗봇 테스트 (http://localhost:4200/ai-chat)
#    - "연차 규정은?" 질문
# 5. 토큰 만료 후 자동 재발급 확인
```

---

## Why This Matters (중요성)

### 1. Monolithic Frontend로 빠른 개발
초기 단계에서는 하나의 Next.js 앱으로 모든 기능을 통합하여 개발 속도와 사용자 경험을 최적화합니다.

### 2. React Hook Form + Zod로 타입 안전한 폼
런타임 검증(Zod)과 TypeScript 타입 추론을 결합하여 폼 에러를 사전에 방지합니다.

### 3. Token Refresh로 끊김 없는 UX
Axios 인터셉터로 토큰 만료 시 자동 재발급하여 사용자가 갑자기 로그아웃되는 것을 방지합니다.

### 4. TanStack Query로 효율적인 데이터 관리
서버 상태를 캐싱하고 자동으로 리페칭하여 불필요한 API 호출을 줄이고 성능을 향상시킵니다.
