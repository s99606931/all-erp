# PRD: GitLab CE 설치 및 설정

## 1. 개요 (Overview)
- **Task ID**: 2.0_gitlab_setup
- **목표**: 자체 호스팅 GitLab CE를 구축하여 소스코드 관리, CI/CD, Container Registry를 통합 운영합니다.
- **관련 로드맵**: Phase 2 - DevOps 환경 구축 (우선)

## 2. 상세 요구사항 (Requirements)
- [ ] **GitLab CE 설치**: Docker 기반 GitLab Community Edition 설치
- [ ] **Container Registry 활성화**: 내장 컨테이너 레지스트리 설정
- [ ] **HTTPS 설정**: SSL/TLS 인증서 적용 (Let's Encrypt 또는 자체 인증서)
- [ ] **백업 전략**: 자동 백업 스케줄 설정
- [ ] **사용자 및 권한 관리**: 개발팀 계정 및 그룹 생성

## 3. 기술적 의사결정 (Technical Decisions)

### 3.1 설치 방법
- **선택지 A**: Docker Compose (권장)
- **선택지 B**: Omnibus 패키지 (직접 설치)
- **선택지 C**: Kubernetes Helm Chart
- **✅ 권장사항**: **Docker Compose**
    - **이유**: 빠른 설치, 쉬운 관리, 백업/복원 용이

### 3.2 Container Registry
- **선택지 A**: GitLab 내장 Container Registry
- **선택지 B**: 별도 Harbor 구축
- **✅ 권장사항**: **GitLab 내장 Container Registry**
    - **이유**: 
        - 통합 인증 (한 번의 로그인으로 Git + Registry 접근)
        - CI/CD 파이프라인과 자동 연동
        - 관리 포인트 최소화 (하나의 시스템만 운영)
        - 초기 단계에서 충분한 기능 제공

### 3.3 도메인 구성
```
https://gitlab.your-domain.com       # GitLab 웹 UI
https://registry.your-domain.com     # Container Registry
```

## 4. 작업 단위 (Work Breakdown)

### 4.1 GitLab CE Docker Compose 설정
`deploy/gitlab/docker-compose.yml` 생성:
```yaml
version: '3.8'
services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    hostname: gitlab.all-erp.local
    container_name: gitlab
    restart: always
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.all-erp.local'
        # Container Registry 설정
        registry_external_url 'https://registry.all-erp.local'
        gitlab_rails['registry_enabled'] = true
        
        # 타임존 설정
        gitlab_rails['time_zone'] = 'Asia/Seoul'
        
        # 백업 설정
        gitlab_rails['backup_keep_time'] = 604800  # 7일
    ports:
      - '80:80'
      - '443:443'
      - '22:22'      # SSH
      - '5050:5050'  # Container Registry
    volumes:
      - './config:/etc/gitlab'
      - './logs:/var/log/gitlab'
      - './data:/var/opt/gitlab'
    shm_size: '256m'
```

### 4.2 초기 설정
```bash
# GitLab 실행
cd deploy/gitlab
docker-compose up -d

# 초기 root 비밀번호 확인
docker exec -it gitlab grep 'Password:' /etc/gitlab/initial_root_password

# 웹 접속 후 설정 변경
# - Admin Area > Settings > General > Sign-up restrictions
# - Admin Area > Settings > CI/CD > Container Registry
```

### 4.3 CI/CD Runner 등록
```bash
# GitLab Runner 설치 (별도 서버 또는 로컬)
docker run -d --name gitlab-runner --restart always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v gitlab-runner-config:/etc/gitlab-runner \
  gitlab/gitlab-runner:latest

# Runner 등록
docker exec -it gitlab-runner gitlab-runner register
# URL: https://gitlab.all-erp.local
# Token: (GitLab Admin Area에서 확인)
# Executor: docker
# Default Image: node:22-alpine
```

## 5. 승인 기준 (Acceptance Criteria)
- [ ] GitLab 웹 UI에 접속할 수 있어야 한다.
- [ ] 테스트 프로젝트를 생성하고 코드를 push할 수 있어야 한다.
- [ ] Container Registry에 이미지를 push/pull할 수 있어야 한다.
- [ ] CI/CD Runner가 정상적으로 등록되어 있어야 한다.

## 6. 참조 문서
- [GitLab CE 공식 문서](https://docs.gitlab.com/ee/install/docker.html)
- [Container Registry 가이드](https://docs.gitlab.com/ee/user/packages/container_registry/)
