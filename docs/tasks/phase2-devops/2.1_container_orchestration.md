# PRD: 컨테이너 및 오케스트레이션 환경 구축

## 1. 개요 (Overview)
- **Task ID**: 2.1_container_orchestration
- **목표**: 모든 마이크로서비스를 컨테이너화하고, 로컬 개발 및 운영 환경을 위한 오케스트레이션 구성을 완료합니다.
- **관련 로드맵**: Phase 2 - 컨테이너 및 오케스트레이션

## 2. 상세 요구사항 (Requirements)
- [ ] **Dockerfile 작성**: NestJS(백엔드) 및 Next.js(프론트엔드)를 위한 최적화된 Dockerfile 작성 (Multi-stage build 적용)
- [ ] **Docker Compose 구성**: 로컬 개발 시 DB(PostgreSQL), Cache(Redis), MQ(RabbitMQ) 및 모든 서비스를 한 번에 띄울 수 있는 `docker-compose.yml` 작성
- [ ] **Kubernetes Manifests**: 운영 배포를 위한 Helm Chart 기본 구조 설계

## 3. 기술적 의사결정 (Technical Decisions)

### 3.1 Docker Image 최적화
- **Base Image**: `node:22-alpine` (2024년 10월부터 LTS, 경량화)
- **Build Strategy**: **Multi-stage Build**
    - `builder`: 의존성 설치 및 빌드 (`pnpm install`, `nx build`)
    - `runner`: 프로덕션 의존성만 복사 및 실행 (`node dist/apps/.../main.js`)
    - **이점**: 이미지 크기 최소화(~100MB), 보안 강화, 빌드 캐시 활용

### 3.2 로컬 개발 환경 (Local Dev)
- **선택지 A**: 모든 서비스를 Docker로 실행
- **선택지 B**: 인프라(DB, MQ)만 Docker로 실행하고, 앱은 로컬(`nx serve`)로 실행
- **✅ 권장사항**: **Hybrid 접근**
    - `docker-compose.infra.yml`: DB, Redis, RabbitMQ 등 인프라만 실행 (개발 시 주로 사용)
    - `docker-compose.yml`: 전체 서비스 실행 (통합 테스트 시 사용)

### 3.3 Container Registry
- **선택**: **GitLab Container Registry** (자체 호스팅)
    - 이미지 푸시: `registry.all-erp.local/project-name/service-name:tag`
    - GitLab CI/CD와 자동 통합
    - 통합 인증 (GitLab 계정으로 로그인)

## 4. 작업 단위 (Work Breakdown)
1.  루트 디렉토리에 공통 `Dockerfile` 템플릿 작성 (Nx 빌드 아티팩트 활용)
2.  `docker-compose.yml` 및 `docker-compose.infra.yml` 작성
    - **Milvus 추가**: `milvus-standalone`, `etcd`, `minio` 서비스 구성 필요
    - **vLLM 추가**: `image: vllm/vllm-openai`, GPU 지원 설정 (`deploy.resources.reservations.devices`)
3.  GitLab Container Registry 연동 설정:
    ```bash
    # GitLab Registry 로그인
    docker login registry.all-erp.local
    # Username: your-gitlab-username
    # Password: your-personal-access-token
    
    # 이미지 빌드 및 푸시
    docker build -t registry.all-erp.local/all-erp/auth-service:latest .
    docker push registry.all-erp.local/all-erp/auth-service:latest
    ```
4.  `deploy/helm` 디렉토리 생성 및 기본 차트 템플릿 구성

## 5. 승인 기준 (Acceptance Criteria)
- [ ] `docker-compose up` 명령어로 모든 서비스가 정상적으로 실행되어야 한다.
- [ ] Docker Image 크기가 최적화되어야 한다 (불필요한 소스 코드 제외).
