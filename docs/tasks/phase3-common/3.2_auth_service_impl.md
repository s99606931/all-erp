# PRD: 인증/인가 서비스 (Auth Service) 구현

## 1. 개요 (Overview)
- **Task ID**: 3.2_auth_service_impl
- **목표**: 사용자의 신원을 검증(Authentication)하고, 권한을 부여(Authorization)하는 중앙 집중식 인증 서비스를 구현합니다.
- **관련 로드맵**: Phase 3 - 인증/인가 서비스

## 2. 상세 요구사항 (Requirements)
- [ ] **회원가입/로그인**: 이메일/비밀번호 기반 로그인
- [ ] **JWT 발급**: Access Token(짧은 만료) 및 Refresh Token(긴 만료) 발급
- [ ] **테넌트 컨텍스트**: 토큰 페이로드에 `tenantId` 포함
- [ ] **RBAC**: 역할(Role) 기반 권한 검증 (Admin, Manager, User)

## 3. 기술적 의사결정 (Technical Decisions)

### 3.1 토큰 전략
- **Access Token**: Header에 담아 전송. 만료 시간 30분~1시간.
- **Refresh Token**: HttpOnly Cookie에 저장하여 XSS 방지. 만료 시간 2주. DB(Redis)에 화이트리스트로 관리하여 강제 로그아웃 지원.

### 3.2 비밀번호 암호화
- **✅ 권장사항**: **Argon2** (`@node-rs/argon2` 사용)
    - **이유**: Bcrypt보다 메모리 기반 공격에 강하고, OWASP 권장 알고리즘입니다.

### 3.3 인증 라이브러리 선택
- **✅ 권장사항**: **`@nestjs/passport` + `passport-jwt`**
    - **이유**: NestJS와 완벽하게 통합되며, 표준적인 전략 패턴으로 확장이 용이합니다. 직접 구현보다 검증된 라이브러리 사용을 권장합니다.

## 4. 작업 단위 (Work Breakdown)

1.  **Prisma Schema 정의**:
    - `auth-service`에 User, Role, RefreshToken 테이블 정의
    - Multi-tenancy 지원을 위한 스키마 구조 설계

2.  **인증 로직 구현**:
    - `AuthService`에 로그인/토큰 발급 로직 구현
    - Argon2로 비밀번호 암호화
    - JWT Access Token 및 Refresh Token 발급

3.  **인가 로직 구현**:
    - `JwtStrategy` 구현 (`@nestjs/passport` 사용)
    - `RolesGuard` 구현 (RBAC)
    - 공통 라이브러리로 분리 검토

4.  **Docker Compose에서 테스트**:
    ```bash
    # auth-service 실행
    cd dev-environment
    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d auth-service
    
    # API 테스트
    curl -X POST http://localhost:3001/api/auth/login \
      -H "Content-Type: application/json" \
      -d '{"email":"test@example.com","password":"password123"}'
    
    # Swagger UI
    open http://localhost:3001/api
    ```

> **참고**: [Docker-First Workflow Guide](../../guides/docker-first-workflow.md)

## 5. 승인 기준 (Acceptance Criteria)
- [ ] **로그인 기능**: Docker Compose 환경에서 로그인 성공 시 JWT Access Token과 Refresh Token 발급
- [ ] **토큰 검증**: 유효하지 않은 토큰으로 API 요청 시 401 에러 발생
- [ ] **토큰 재발급**: Refresh Token을 통해 Access Token 재발급 가능
- [ ] **Swagger UI**: `http://localhost:3001/api`에서 인증 API 테스트 가능
