# PRD: 공통 모듈 (Shared Libs) 개발

## 1. 개요 (Overview)
- **Task ID**: 3.1_shared_libs
- **목표**: 모든 마이크로서비스에서 중복 사용되는 코드(DTO, 유틸리티, 인프라 설정)를 라이브러리로 분리하여 재사용성을 높입니다.
- **관련 로드맵**: Phase 3 - 공통 모듈 개발

## 2. 상세 요구사항 (Requirements)
- [ ] **Shared Util**: 날짜 처리, 문자열 조작, 암호화 등 순수 함수 모음
- [ ] **Shared Domain**: 공통 DTO(응답 래퍼, 페이징), 에러 정의(Exception Filter)
- [ ] **Shared Infra**: Prisma Client 설정, RabbitMQ 연결 모듈, Logger 모듈
- [ ] **Multi-tenancy Core**: 테넌트 컨텍스트 미들웨어 및 Prisma 확장(Extension) 구현

## 3. 기술적 의사결정 (Technical Decisions)

### 3.1 라이브러리 구조 (Nx Libs)
- `libs/shared/util`: 의존성이 거의 없는 순수 유틸리티
- `libs/shared/domain`: 비즈니스 로직에서 사용되는 타입 및 인터페이스
- `libs/shared/infra`: 외부 시스템(DB, MQ)과의 연동을 담당하는 모듈 (NestJS Module 형태)

### 3.2 에러 핸들링 표준
- **Global Exception Filter**를 구현하여 모든 예외를 표준 응답 포맷(`{ success: false, code: "ERR_001", message: "..." }`)으로 변환합니다.

## 4. 작업 단위 (Work Breakdown)

1.  **Shared Utility 라이브러리 생성**:
    - `pnpm nx g @nx/js:lib shared-util --directory=libs/shared/util`
    - 날짜 처리, 문자열 조작, 암호화 등 순수 함수 구현

2.  **Shared Infrastructure 라이브러리 생성**:
    - `pnpm nx g @nx/nest:lib shared-infra --directory=libs/shared/infra`
    - Prisma Client, RabbitMQ 연결 모듈, Logger 모듈 구현

3.  **Shared Domain 라이브러리 생성**:
    - `libs/shared/domain`에 공통 Response DTO 및 Exception 클래스 정의
    - Global Exception Filter 구현

4.  **Docker Compose에서 테스트**:
    ```bash
    # 라이브러리 테스트
    pnpm nx test shared-util
    pnpm nx test shared-infra
    
    # 영향받는 서비스 확인
    pnpm nx affected:test --base=main
    
    # Docker Compose로 통합 테스트
    cd dev-environment
    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d
    ```

> **참고**: [Docker-First Workflow Guide](../../guides/docker-first-workflow.md)

## 5. 승인 기준 (Acceptance Criteria)
- [ ] **라이브러리 import**: 각 서비스에서 `import { ... } from '@all-erp/shared/util'` 형태로 라이브러리 사용 가능
- [ ] **영향도 분석**: 공통 모듈 수정 시 `nx affected`로 의존하는 모든 앱 확인
- [ ] **Docker 환경 테스트**: Docker Compose에서 모든 서비스가 공통 라이브러리를 정상 사용
