# PRD: 시스템 및 테넌트 관리 서비스 구현

## 1. 개요 (Overview)
- **Task ID**: 3.3_system_tenant_impl
- **목표**: SaaS 운영을 위한 테넌트 관리 기능과 시스템 전반의 공통 데이터(코드, 조직)를 관리하는 기능을 구현합니다.
- **관련 로드맵**: Phase 3 - 시스템 및 테넌트 관리

## 2. 상세 요구사항 (Requirements)
- [ ] **테넌트 관리 (`tenant-service`)**:
    - 테넌트 생성 (Onboarding): 신규 고객사 등록 및 초기 데이터(Admin 계정, 스키마) 생성
    - 구독 관리: 서비스 이용 기간 및 플랜 관리
- [ ] **시스템 관리 (`system-service`)**:
    - 공통 코드 관리: 시스템 전반에서 사용하는 코드(직급, 부서 유형 등) 관리
    - 조직/부서 관리: 테넌트별 조직도 트리 구조 관리

## 3. 기술적 의사결정 (Technical Decisions)

### 3.1 테넌트 생성 프로세스 (Onboarding)
- 테넌트 생성 요청 -> `tenant-service` DB 등록 -> **Event 발행 (TenantCreated)** -> `auth-service`, `system-service` 등 타 서비스에서 해당 테넌트용 초기 데이터/스키마 생성 (비동기 처리)

### 3.2 공통 코드 캐싱
- 공통 코드는 변경 빈도가 낮고 조회 빈도가 높으므로 **Redis**를 활용한 캐싱 전략을 적용합니다.

## 4. 작업 단위 (Work Breakdown)

1.  **Tenant Service 구현**:
    - Tenant 엔티티 설계 (id, name, subdomain, subscription_plan, created_at)
    - Tenant CRUD API 구현
    - Tenant 생성 시 스키마 마이그레이션 자동화 스크립트

2.  **System Service 구현**:
    - CommonCode, Department 엔티티 설계
    - CRUD API 구현
    - Redis 캠싱 적용 (공통 코드)

3.  **이벤트 기반 온보딩**:
    - RabbitMQ를 통한 `TenantCreated` 이벤트 발행
    - 타 서비스에서 이벤트 수신 및 초기 데이터 생성

4.  **Docker Compose에서 테스트**:
    ```bash
    # 서비스 실행
    cd dev-environment
    docker compose -f docker-compose.infra.yml -f docker-compose.dev.yml up -d tenant-service system-service
    
    # 테넌트 생성 API 테스트
    curl -X POST http://localhost:3006/api/tenants \
      -H "Content-Type: application/json" \
      -d '{"name":"Test Company","subdomain":"test"}'
    
    # 스키마 생성 확인
    docker compose exec postgres psql -U postgres -d all_erp -c "\dn"
    ```

> **참고**: [Docker-First Workflow Guide](../../guides/docker-first-workflow.md)

## 5. 승인 기준 (Acceptance Criteria)
- [ ] **테넌트 생성**: Docker Compose 환경에서 신규 테넌트 생성 시 DB 스키마 자동 생성
- [ ] **조직도 관리**: 각 테넌트별로 독립적인 조직도 구성 가능
- [ ] **API 테스트**: Swagger UI를 통해 tenant-service(3006), system-service(3002) API 테스트
- [ ] **이벤트 처리**: 테넌트 생성 시 RabbitMQ 이벤트가 발행되고 타 서비스에서 수신
