# PRD: SaaS 멀티테넌시 전략 수립

## 1. 개요 (Overview)
- **Task ID**: 1.3_multitenancy_strategy
- **목표**: 다수의 고객사(Tenant)가 하나의 플랫폼을 사용하면서도 데이터와 환경이 완벽하게 분리되도록 아키텍처를 설계합니다.
- **관련 로드맵**: Phase 1 - SaaS 멀티테넌시 전략 수립

## 2. 상세 요구사항 (Requirements)
- [ ] **테넌트 식별 전략**: 요청이 들어왔을 때 어느 고객사의 요청인지 식별하는 메커니즘 정의
- [ ] **데이터 격리 전략**: DB 레벨에서 고객사 데이터를 어떻게 분리할지 결정
- [ ] **테넌트 컨텍스트 전파**: 마이크로서비스 간 통신 시 테넌트 정보를 어떻게 전달할지 정의 (Header 등)

## 3. 기술적 의사결정 (Technical Decisions)

### 3.1 데이터 격리 수준 (Database Isolation)
- **선택지 A**: **Database per Tenant** (물리적 분리)
    - 장점: 완벽한 격리, 보안 최상
    - 단점: 비용 높음, 인프라 관리 복잡
- **선택지 B**: **Schema per Tenant** (논리적 분리 - 스키마)
    - 장점: 적절한 격리, 비용 효율적, 백업/복구 용이
    - 단점: 마이그레이션 시 모든 스키마 적용 필요
- **선택지 C**: **Row Level Security (Discriminator Column)** (논리적 분리 - 컬럼)
    - 장점: 비용 최저, 개발 용이
    - 단점: 개발자 실수로 데이터 유출 위험, 데이터 양 증가 시 성능 저하
- **✅ 권장사항**: **`Schema per Tenant` (PostgreSQL)**
    - **이유**: B2B ERP 특성상 데이터 보안이 중요하므로 Row Level은 위험합니다. Database per Tenant는 비용 부담이 큽니다. PostgreSQL의 Schema 기능을 활용하면 비용과 보안의 균형을 맞출 수 있습니다.

### 3.2 테넌트 식별 (Tenant Identification)
- **선택지 A**: **Subdomain** (`tenantA.erp.com`)
- **선택지 B**: **Path** (`erp.com/tenantA`)
- **선택지 C**: **Header** (`X-Tenant-ID`)
- **✅ 권장사항**: **`Subdomain` + `Header`**
    - **이유**: 프론트엔드 진입점은 `Subdomain`으로 구분하여 사용자 경험을 분리하고, 내부 API 통신 및 게이트웨이 이후에는 `X-Tenant-ID` 헤더로 통일하여 처리합니다.

## 4. 작업 단위 (Work Breakdown)
1.  멀티테넌시 아키텍처 문서 작성 (`docs/architecture/multitenancy.md`)
2.  Prisma Schema 관리 전략 수립 (스키마 분리 자동화 스크립트 구상)
3.  NestJS Middleware/Guard 설계를 위한 POC (Proof of Concept) 코드 작성

## 5. 승인 기준 (Acceptance Criteria)
- [ ] 테넌트별 데이터 격리 방식이 확정되어야 한다.
- [ ] API 요청 시 테넌트를 식별하고 DB 연결을 동적으로 전환하는 메커니즘이 설계되어야 한다.
