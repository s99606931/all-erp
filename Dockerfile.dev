FROM node:22-alpine

# 작업 디렉토리 설정
WORKDIR /workspace

# pnpm 설치
# pnpm 설치 (Corepack 사용)
RUN corepack enable && corepack prepare pnpm@latest --activate

# 의존성 파일만 먼저 복사 (캐싱 최적화)
COPY package.json pnpm-lock.yaml ./
COPY nx.json tsconfig.base.json ./
COPY prisma.config.ts ./

# 의존성 설치
RUN pnpm install

# Prisma schema 복사 및 Prisma Client 생성
# Prisma schema 복사 및 Prisma Client 생성
COPY libs/shared/infra/prisma ./libs/shared/infra/prisma
# 빌드 시점에는 DB 연결이 필요 없지만, 설정 파일 로딩을 위해 더미 URL 제공
ENV DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy"
RUN pnpm prisma generate

# 소스 코드는 볼륨 마운트로 제공됨
# Hot Reload를 위해 watch 모드로 실행

# 개발 서버 실행 (각 서비스별로 CMD 오버라이드)
CMD ["pnpm", "nx", "serve"]
